!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("util"),require("rxjs"),require("dexie"),require("rxjs/operators"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","util","rxjs","dexie","rxjs/operators","lodash"],t):t(e["ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.util,e.rxjs,e.Dexie,e.operators,e.lodash)}(this,function(r,o,e,s,a,c,t,u,i){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var d,n=(d=function(e,t){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),h=function(n,i){var r,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},p=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i},l=function(){this.number=1,this.total_resources=0,this.size=0,this.resources_per_page=0},f=(v.propagateLoaded=function(e,t){for(var n in e){var i=e[n];i instanceof x&&i.setLoaded(t&&i.builded)}},v);function v(){}var g=(y.prototype.applyParams=function(e,t){if(void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include),function(e){return void 0!==e.id||void 0!==e.include_get||void 0!==e.include_save}(t)&&t.include_get&&this.setInclude(p(this.includes,t.include_get)),t.fields&&0<Object.keys(t.fields).length)for(var n in t.fields){var i="fields["+n+"]="+t.fields[n].join(",");this.get_params.push(i)}},y.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},y.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},y.prototype.get=function(){var e=p(this.get_params);return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(0<e.length?te.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},y.prototype.setInclude=function(e){this.includes=e},y);function y(){this.paths=[],this.includes=[],this.get_params=[]}var b=(m.json_array2resources_array_by_type=function(e){var t={},n={};for(var i in m.json_array2resources_array(e,t),t){var r=t[i];r.type in n||(n[r.type]={}),n[r.type][r.id]=r}return n},m.json2resource=function(e,t){if(m.getService(e.type))return m.procreate(e);o.isDevMode()&&console.warn("`"+e.type+"`","service not found on json2resource().","Use @Autoregister() on service and inject it on component.");var n=new j;return n.id=e.id,n.type=e.type,n},m.getService=function(e){return te.me.getResourceService(e)},m.getServiceOrFail=function(e){return te.me.getResourceServiceOrFail(e)},m.buildIncluded=function(e){return"included"in e&&e.included?m.json_array2resources_array_by_type(e.included):{}},m.procreate=function(e){"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e);var t=A.getInstance().getOrCreateResource(e.type,e.id);return t.fill({data:e}),t.is_new=!1,t},m.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var n=0,i=e;n<i.length;n++){var r=i[n],o=m.json2resource(r,!1);t[o.type+"_"+o.id]=o}},m);function m(){}var _=(w.prototype.buildRelationships=function(){for(var e in this.relationships_from){var t=this.relationships_from[e];this.relationships_dest[e]&&null===t.data&&(this.relationships_dest[e].data=null,this.relationships_dest[e].builded=!0,this.relationships_dest[e].is_loading=!1,this.relationships_dest[e].loaded=!0),t.data&&(this.relationships_dest[e]instanceof x?this.__buildRelationshipHasMany(t,e):this.relationships_dest[e]instanceof k&&this.__buildRelationshipHasOne(t,e))}},w.prototype.__buildRelationshipHasMany=function(e,t){if(0===e.data.length)return this.relationships_dest[t]=new x,void(this.relationships_dest[t].builded=!0);this.relationships_dest[t].fill(e)},w.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(this.relationships_dest[t].data||(this.relationships_dest[t].data=new j),e.data.id!==this.relationships_dest[t].data.id&&(this.relationships_dest[t].data=new j,this.relationships_dest[t].data.type=e.data.type),this.relationships_dest[t].data.id!==e.data.id||!this.relationships_dest[t].data.attributes||0===Object.keys(this.relationships_dest[t].data.attributes).length){var n=this.__buildRelationship(e.data);n?(this.relationships_dest[t].data=n,this.relationships_dest[t].builded=!0):(this.relationships_dest[t].data.id=e.data.id,this.relationships_dest[t].data.type=e.data.type)}}else this.relationships_dest[t].data=[]},w.prototype.__buildRelationship=function(e){if(e.type in this.included_resources&&e.id in this.included_resources[e.type]){var t=this.included_resources[e.type][e.id];return A.getInstance().setResource(t,!0),t}this.getService(e.type);var n=A.getInstance().getResource(e.type,e.id);if(n)return n},w);function w(e,t,n,i){this.getService=e,this.relationships_from=t,this.relationships_dest=n,this.included_resources=i}var j=(O.prototype.reset=function(){for(var e in this.id="",this.attributes={},this.is_new=!0,this.relationships)this.relationships[e]=this.relationships[e]instanceof x?new x:new k},O.prototype.toObject=function(e){var t,n={},i=[],r=[],o=(e=Object.assign(Object.assign({},F.ParamsResource),e)).include||[];for(var s in e.include_save&&(o=o.concat(e.include_save)),this.relationships){var a=this.relationships[s];if(a instanceof x){a.builded||a.data&&0!==a.data.length?n[s]={data:[]}:delete n[s];for(var c=0,u=a.data;c<u.length;c++){var d=u[c],h={id:d.id,type:d.type};n[s].data.push(h);var p=d.type+"_"+d.id;-1===r.indexOf(p)&&o&&-1!==o.indexOf(s)&&(r.push(p),i.push(d.toObject({}).data))}}else{if(null===a.data||void 0===a.data){n[s]={data:a.data};continue}a instanceof k||console.warn(a," is not DocumentCollection or DocumentResource");var l=a.data;if(a.data&&!("id"in a.data)&&0<Object.keys(a.data).length&&console.warn(s+" defined with hasMany:false, but I have a collection"),l.id&&l.type)n[s]={data:{id:l.id,type:l.type}};else if(!a.builded&&!l.id&&!l.type){delete n[s];continue}p=l.type+"_"+l.id,-1===r.indexOf(p)&&o&&-1!==o.indexOf(s)&&(r.push(p),i.push(l.toObject({}).data))}}this.getService()&&this.getService().parseToServer?(t=Object.assign({},this.attributes),this.getService().parseToServer(t)):t=this.attributes;var f={data:{type:this.type,id:this.id,attributes:t,relationships:n}};return this.meta&&(f.data.meta=this.meta),e.meta&&(f.meta=e.meta),0<i.length&&(f.included=i),f},O.prototype.fill=function(e){this.id=e.data.id||"",this.attributes=Object.assign(Object.assign({},this.attributes||{}),e.data.attributes),this.data_resource=e,this.is_new=!1;var t=b.getService(e.data.type);if(!this.relationships&&t&&(this.relationships=(new t.resource).relationships),!t)return!1;if(Object.keys(this.attributes).length){var n=b.getService(this.type);n&&"parseFromServer"in n&&n.parseFromServer(this.attributes)}return"cache_last_update"in e.data&&(this.cache_last_update=e.data.cache_last_update),new _(b.getService,e.data.relationships||{},this.relationships,b.buildIncluded(e)).buildRelationships(),!0},O.prototype.addRelationship=function(e,t){var n=this.relationships[t||e.type];n instanceof x?n.replaceOrAdd(e):n.data=e},O.prototype.addRelationships=function(e,t){var n=this;if(0!==e.length){if(!(this.relationships[t]instanceof x))throw new Error("addRelationships require a DocumentCollection (hasMany) relation.");e.forEach(function(e){n.addRelationship(e,t)})}},O.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;var n=this.relationships[e];return n instanceof x?(n.data=n.data.filter(function(e){return e.id!==t}),0===n.data.length&&(n.builded=!0)):n.data=null,!0},O.prototype.hasManyRelated=function(e){return this.relationships[e]&&0<this.relationships[e].data.length},O.prototype.hasOneRelated=function(e){return Boolean(this.relationships[e]&&this.relationships[e].data.type&&""!==this.relationships[e].data.type)},O.prototype.restore=function(e){return void 0===e&&(e={}),e.meta=Object.assign(Object.assign({},e.meta),{restore:!0}),this.save(e)},O.prototype.getService=function(){return b.getServiceOrFail(this.type)},O.prototype.delete=function(){return this.getService().delete(this.id)},O.prototype.save=function(e){var t=this;if(e=Object.assign(Object.assign({},F.ParamsResource),e),this.is_saving||!this.loaded)return c.of({});this.is_saving=!0;var n=new c.Subject,i=this.toObject(e);""===this.id&&delete i.data.id;var r=new g;return r.applyParams(this.getService(),e),this.id&&r.appendPath(this.id),te.exec(r.get(),this.is_new?"POST":"PATCH",i,!0).subscribe(function(e){t.is_saving=!1,t.id||(A.getInstance().deprecateCollections(r.get()),(new z).deprecateCollection(r.get())),"id"in e.data?(t.id=e.data.id,t.fill(e)):a.isArray(e.data)&&console.warn("Server return a collection when we save()",e.data),n.next(e),n.complete()},function(e){t.is_saving=!1,n.error("data"in e?e.data:e)}),n.asObservable()},O.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},O.prototype.setLoadedAndPropagate=function(e){this.setLoaded(e),f.propagateLoaded(this.relationships,e)},O.prototype.setSource=function(e){this.source=e},O.prototype.setSourceAndPropagate=function(e){for(var t in this.setSource(e),this.relationships){var n=this.relationships[t];n instanceof x&&n.setSource(e)}},O.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},O);function O(){this.id="",this.type="",this.attributes={},this.relationships={},this.links={},this.is_new=!0,this.is_saving=!1,this.is_loading=!1,this.loaded=!0,this.source="new",this.cache_last_update=0,this.ttl=0}function R(){this.builded=!1,this.is_loading=!0,this.loaded=!1,this.source="new",this.cache_last_update=0,this.meta={}}var C,S=(n(P,C=R),P.prototype.trackBy=function(e){return e.id},P.prototype.find=function(e){if("ids"===this.content)return null;for(var t=0;t<this.data.length;t++)if(this.data[t].id===e)return this.data[t];return null},P.prototype.fill=function(e){this.data_collection=e,b.buildIncluded(e),this.page&&e.meta&&(this.page.number=e.meta.page||1,this.page.resources_per_page=e.meta.resources_per_page||null,this.page.size=e.meta.resources_per_page||null,this.page.total_resources=e.meta.total_resources||null);var t={};this.data.length=0,this.builded=e.data&&0===e.data.length;for(var n=0,i=e.data;n<i.length;n++){var r=i[n];try{var o=this.getResourceOrFail(r);o.fill({data:r}),t[r.id]=r.id,this.data.push(o),0<Object.keys(o.attributes).length&&(this.builded=!0)}catch(e){this.content="ids",this.builded=!1,this.data.push({id:r.id,type:r.type})}}for(var s=void 0;s<this.data.length;s++)this.data[s].id in t||delete this.data[s];this.meta=e.meta||{},"cache_last_update"in e&&(this.cache_last_update=e.cache_last_update)},P.prototype.getResourceOrFail=function(e){var t=this.find(e.id);if(null!==t)return t;var n=b.getService(e.type);if(!n)throw o.isDevMode()&&console.warn("The relationship relation_alias? (type "+e.type+") cant be generated because service for this type has not been injected."),new Error("Cant create service for "+e.type);return n.getOrCreateResource(e.id)},P.prototype.replaceOrAdd=function(e){var t=this.find(e.id);null===t?this.data.push(e):t=e},P.prototype.hasMorePages=function(){return!this.page.size||this.page.size<1?null:this.page.size*(this.page.number-1)+this.data.length<this.page.total_resources},P.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},P.prototype.setLoadedAndPropagate=function(t){this.setLoaded(t),"ids"!==this.content&&this.data.forEach(function(e){f.propagateLoaded(e.relationships,t)})},P.prototype.setBuilded=function(e){this.builded=e},P.prototype.setBuildedAndPropagate=function(t){this.setBuilded(t),"ids"!==this.content&&this.data.forEach(function(e){e.setLoaded(t)})},P.prototype.setSource=function(e){this.source=e},P.prototype.setSourceAndPropagate=function(t){this.setSource(t),this.data.forEach(function(e){e instanceof j&&e.setSource(t)})},P.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},P.prototype.setCacheLastUpdateAndPropagate=function(t){void 0===t&&(t=Date.now()),this.setCacheLastUpdate(t),this.data.forEach(function(e){e instanceof j&&e.setCacheLastUpdate(t)})},P.prototype.toObject=function(t){return this.builded?{data:this.data.map(function(e){return e.toObject(t).data})}:{data:this.data}},P);function P(){var e=C.apply(this,arguments)||this;return e.data=[],e.page=new l,e.ttl=0,e.content="ids",e}var E,x=(n(D,E=S),D);function D(){var e=E.apply(this,arguments)||this;return e.data=[],e.content="collection",e}var F=(I.newCollection=function(){return new x},I.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},I.forEach=function(t,n){Object.keys(t).forEach(function(e){n(t[e],e)})},I);function I(){}F.ParamsResource={beforepath:"",ttl:void 0,include:[],fields:{},id:""},F.ParamsCollection={beforepath:"",ttl:void 0,include:[],remotefilter:{},fields:{},smartfilter:{},sort:[],page:new l,store_cache_method:"individual",storage_ttl:0,cachehash:""};var A=(L.getInstance=function(){return L.instance||(L.instance=new L),L.instance},L.prototype.clearCache=function(){this.resources={},this.collections={},L.instance=null},L.prototype.getResource=function(e,t){return this.getKey(e,t)in this.resources?this.resources[this.getKey(e,t)]:null},L.prototype.getResourceOrFail=function(e,t){if(this.getKey(e,t)in this.resources)return this.resources[this.getKey(e,t)];throw new Error("The requested resource does not exist in cache memory")},L.prototype.getKey=function(e,t){return e+"."+t},L.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=new x,this.collections[e].source="new"),this.collections[e]},L.prototype.setCollection=function(e,t){e in this.collections||(this.collections[e]=new x);for(var n=0;n<t.data.length;n++){var i=t.data[n];this.setResource(i,!0)}this.collections[e].data=t.data,this.collections[e].page=t.page,this.collections[e].cache_last_update=t.cache_last_update},L.prototype.getOrCreateResource=function(e,t){var n=this.getResource(e,t);return null!==n||((n=b.getServiceOrFail(e).new()).id=t,this.setResource(n,!1)),n},L.prototype.setResource=function(e,t){void 0===t&&(t=!1),this.getKey(e.type,e.id)in this.resources?this.fillExistentResource(e):this.resources[this.getKey(e.type,e.id)]=e,this.resources[this.getKey(e.type,e.id)].cache_last_update=t?Date.now():0},L.prototype.deprecateCollections=function(e){for(var t in void 0===e&&(e=""),this.collections)t.includes(e)&&(this.collections[t].cache_last_update=0);return!0},L.prototype.removeResource=function(n,i){var e=this.getResource(n,i);if(e){for(var t in F.forEach(this.collections,function(e,t){e.data.splice(e.data.findIndex(function(e){return e.type===n&&e.id===i}),1)}),e.attributes={},e.relationships)null!==e.relationships[t].data&&void 0!==e.relationships[t].data&&(e.relationships[t].data instanceof Array?e.relationships[t].data=[]:e.relationships[t].data instanceof Object&&delete e.relationships[t].data);delete this.resources[this.getKey(n,i)]}},L.prototype.fillExistentResource=function(e){var t=this.getResourceOrFail(e.type,e.id);t.attributes=Object.assign(Object.assign({},t.attributes),e.attributes),t.relationships=t.relationships||e.relationships},L);function L(){this.resources={},this.collections={}}var J,k=(n(T,J=R),T.prototype.fill=function(e){this.builded=!1,this.content="id",null!==(this.data_resource=e)?(this.data||(this.data=A.getInstance().getOrCreateResource(e.data.type,e.data.id)),this.data.fill(e)&&(this.builded=!0,this.content="resource"),this.meta=e.meta||{}):this.data=null},T.prototype.unsetData=function(){this.data=void 0,this.builded=!1},T);function T(){var e=J.apply(this,arguments)||this;return e.data=new j,e.builded=!1,e.content="id",e}var q=function(e,s,a,c){return new(a||(a=Promise))(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},M=(K.prototype.getElement=function(n,i){return void 0===i&&(i="elements"),q(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return[4,K.db.open()];case 1:return e.sent(),[4,K.db.table(i).get(n)];case 2:if(void 0===(t=e.sent()))throw new Error(n+" not found.");return[2,t]}})})},K.prototype.getElements=function(n,i){return void 0===i&&(i="elements"),q(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return t={},[4,K.db.table(i).where(":id").anyOf(n).each(function(e){t[e.data.type+"."+e.data.id]=e})];case 1:return e.sent(),[2,n.map(function(e){return t[e]})]}})})},K.prototype.updateElements=function(n,e,i){return void 0===i&&(i="elements"),q(this,void 0,void 0,function(){var t=this;return h(this,function(e){return[2,K.db.open().then(function(){return q(t,void 0,void 0,function(){return h(this,function(e){return""===n?[2,K.db.table(i).clear()]:[2,K.db.table(i).where(":id").startsWith(n).delete().then(function(){})]})})})]})})},K.prototype.saveElements=function(i,r){return void 0===r&&(r="elements"),q(this,void 0,void 0,function(){var t,n;return h(this,function(e){return t=[],n=i.map(function(e){return t.push(e.key),e.content}),[2,K.db.open().then(function(){K.db.table(r).bulkPut(n,t)})]})})},K);function K(){K.db||(K.db=new t("dexie_data_provider")).version(1).stores({collections:"",elements:""})}var H=function(e,s,a,c){return new(a||(a=Promise))(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},z=(B.prototype.getResource=function(r,o){return void 0===o&&(o=[]),H(this,void 0,void 0,function(){var n,i,t;return h(this,function(e){switch(e.label){case 0:return[4,this.getDataResources([r])];case 1:if(void 0===(n=e.sent().shift()))throw new Error("Resource "+r+" don't found.");return 0===o.length?[2,n]:(i=[],o.forEach(function(e){if(!n||!n.data.relationships||!n.data.relationships[e])throw new Error("We dont have relation_alias on stored data resource");var t=n.data.relationships[e].data;t instanceof Array?t.forEach(function(e){i.push(B.getResourceKey(e))}):t&&"id"in t&&i.push(B.getResourceKey(t))}),[4,this.getDataResources(i)]);case 2:return t=e.sent(),[2,Object.assign(Object.assign({},n),{included:t.map(function(e){return e.data})})]}})})},B.prototype.getCollection=function(s,a){return void 0===a&&(a=[]),H(this,void 0,void 0,function(){var t,i,n,r,o;return h(this,function(e){switch(e.label){case 0:return[4,this.getDataCollection(s)];case 1:return t=e.sent(),[4,this.getDataResources(t.keys)];case 2:return i=e.sent(),n={data:i.map(function(e){return e.data}),cache_last_update:t.updated_at},0===a.length?[2,n]:(r=[],a.forEach(function(n){i.forEach(function(e){if(e.data.relationships&&e.data.relationships[n]){var t=e.data.relationships[n].data;t instanceof Array?t.forEach(function(e){r.push(B.getResourceKey(e))}):"id"in t&&r.push(B.getResourceKey(t))}})}),[4,this.getDataResources(r)]);case 3:return o=e.sent(),[2,Object.assign(Object.assign({},n),{included:o.map(function(e){return e.data})})]}})})},B.prototype.getDataCollection=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.getElement(t,"collections")]})})},B.prototype.getDataResources=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.getElements(t,"elements")]})})},B.prototype.saveCollection=function(e,t,n){void 0===n&&(n=[]),this.dataProvider.saveElements(B.collectionToElement(e,t),"collections"),this.dataProvider.saveElements(B.collectionResourcesToElements(t,n),"elements")},B.prototype.saveResource=function(t,n){return void 0===n&&(n=[]),H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.saveElements(B.toResourceElements(B.getResourceKey(t),t,n),"elements")]})})},B.collectionToElement=function(e,t){var n={key:e,content:{updated_at:Date.now(),keys:[]}};return t.data.forEach(function(e){var t=B.getResourceKey(e);n.content.keys.push(t)}),[n]},B.collectionResourcesToElements=function(e,n){void 0===n&&(n=[]);var i=[];return e.data.forEach(function(e){var t=B.getResourceKey(e);i.push.apply(i,B.toResourceElements(t,e,n))}),i},B.toResourceElements=function(e,n,t){void 0===t&&(t=[]);var i=[{key:e,content:n.toObject()}];return i[0].content.data.cache_last_update=Date.now(),t.forEach(function(e){var t=n.relationships[e];if(t instanceof x)t.data.forEach(function(e){i.push(B.getElement(e))});else if(t instanceof k){if(null===t.data||void 0===t.data)return;i.push(B.getElement(t.data))}}),i},B.getResourceKey=function(e){return e.type+"."+e.id},B.getElement=function(e){return{key:B.getResourceKey(e),content:e.toObject()}},B.prototype.deprecateCollection=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.updateElements(t,{},"collections")]})})},B);function B(){this.dataProvider=new M}function G(e,t){var n=t&&"number"==typeof t?t:e.ttl||0;return Date.now()<e.cache_last_update+1e3*n}function U(e,t,n){var i=n.value;return n.value=function(){var e,t=Array.prototype.slice.call(arguments);try{e="string"==typeof t[0]?t[0]:t[0].type}catch(e){return console.warn("ERROR: First argument of methods decorated with serviceIsRegistered has to be string or Resource."),null}return te.me.getResourceService(e)?i.apply(this,t):(console.warn("ERROR: "+e+" service has not been registered."),null)},n}var W=function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.cachestore_support=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}};W.ɵfac=function(e){return new(e||W)},W.ɵprov=o.ɵɵdefineInjectable({token:W,factory:W.ɵfac,providedIn:"root"});var N=(V.prototype.setHttpClient=function(e){this.http=e},V.prototype.exec=function(e,t,n){var i=this,r={body:n||null,headers:new s.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})};if("get"!==t)return this.http.request(t,this.rsJsonapiConfig.url+e,r).pipe(u.tap(function(){delete i.get_requests[e]}),u.share());if(this.get_requests[e])return this.get_requests[e];var o=this.http.request(t,this.rsJsonapiConfig.url+e,r).pipe(u.tap(function(){delete i.get_requests[e]}),u.share());return this.get_requests[e]=o},V);function V(){this.get_requests={},this.rsJsonapiConfig=r.JsonapiInjector.get(W)}N.ɵfac=function(e){return new(e||N)},N.ɵprov=o.ɵɵdefineInjectable({token:N,factory:N.ɵfac});var Q=function(e,s,a,c){return new(a||(a=Promise))(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},X=(Y.prototype.getDataObject=function(i,r){return Q(this,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return t="collection"===i?"collections":"elements",[4,this.db.open()];case 1:return e.sent(),[4,this.db.table(t).get(i+"."+r)];case 2:if(void 0===(n=e.sent()))throw new Error;return[2,n]}})})},Y.prototype.getDataResources=function(i){return Q(this,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return t=this.db.table("elements").where(":id").anyOf(i),n={},[4,t.each(function(e){n[e.id]=e})];case 1:return e.sent(),[2,n]}})})},Y.prototype.saveResource=function(t,n,e){var i=this,r=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return Q(i,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").put(r,t+"."+n)]})})})},Y.prototype.saveCollection=function(t,e){var n=this,i=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return Q(n,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").put(i,"collection."+t)]})})})},Y.prototype.clearCache=function(){var e=this;this.db.open().then(function(){return Q(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").toCollection().delete()]})})}),this.db.open().then(function(){return Q(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").toCollection().delete()]})})})},Y.prototype.deprecateResource=function(t,n){var e=this;this.db.open().then(function(){return Q(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").where(":id").startsWith(t+"."+n).modify({cache_last_update:0})]})})})},Y.prototype.deprecateCollection=function(t){var e=this;this.db.open().then(function(){return Q(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").where(":id").startsWith(t).modify({cache_last_update:0})]})})})},Y.prototype.removeObjectsWithKey=function(e){return Q(this,void 0,void 0,function(){return h(this,function(e){return[2]})})},Y.prototype.checkIfIsTimeToClean=function(){},Y.prototype.checkAndDeleteOldElements=function(){},Y);function Y(){this.db=new t("jsonapi_db"),this.db.version(1).stores({collections:"",elements:""}),this.checkIfIsTimeToClean()}X.ɵfac=function(e){return new(e||X)},X.ɵprov=o.ɵɵdefineInjectable({token:X,factory:X.ɵfac});var Z=function(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;0<=a;a--)(r=e[a])&&(s=(o<3?r(s):3<o?r(t,n,s):r(t,n))||s);return 3<o&&s&&Object.defineProperty(t,n,s),s},$=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ee=function(e,s,a,c){return new(a||(a=Promise))(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},te=(ne.prototype.setHttpClient=function(e){ne.injectedServices.JsonapiHttp.setHttpClient(e)},ne.delete=function(e){return ne.exec(e,"DELETE")},ne.get=function(e){return ne.exec(e,"get")},ne.exec=function(e,t,n,i){return void 0===i&&(i=!0),ne.me.refreshLoadings(1),ne.injectedServices.JsonapiHttp.exec(e,t,n).pipe(u.tap(function(){return ne.me.refreshLoadings(-1)}),u.catchError(function(e){return e=e.error||e,ne.me.refreshLoadings(-1),e.status<=0?!ne.me.loadingsOffline(e)&&o.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):i&&!ne.me.loadingsError(e)&&o.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),c.throwError(e)}))},ne.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},ne.prototype.getResourceService=function(e){return this.resourceServices[e]},ne.prototype.getResourceServiceOrFail=function(e){var t=this.resourceServices[e];if(!t)throw new Error("The requested service with type "+e+" has not been registered, please use register() method or @Autoregister() decorator");return t},ne.removeCachedResource=function(e,t){A.getInstance().removeResource(e,t)},ne.setCachedResource=function(e){A.getInstance().setResource(e,!0)},ne.deprecateCachedCollections=function(e){var t=ne.me.getResourceServiceOrFail(e),n=new g;n.applyParams(t),A.getInstance().deprecateCollections(n.getForCache())},ne.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},ne.prototype.clearCache=function(){return ee(this,void 0,void 0,function(){return h(this,function(e){return ne.injectedServices.JsonapiStoreService.clearCache(),A.getInstance().clearCache(),[2,(new z).deprecateCollection("").then(function(){return!0})]})})},ne.prototype.duplicateResource=function(n){for(var i=this,r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];var o=this.getResourceServiceOrFail(n.type).new();function t(t){var e=n.relationships[t];if(!e.data)return o.relationships[t]=n.relationships[t],"continue";"id"in e.data?-1<r.indexOf(t)?o.addRelationship(s.duplicateResource(e.data),t):o.addRelationship(e.data,t):-1<r.indexOf(t)?e.data.forEach(function(e){o.addRelationship(i.duplicateResource(e),t)}):o.addRelationships(e.data,t)}o.id="new_"+Math.floor(1e4*Math.random()).toString(),o.attributes=Object.assign(Object.assign({},o.attributes),n.attributes);var s=this;for(var a in n.relationships)t(a);return o},ne);function ne(){this.loadingsCounter=0,this.loadingsStart=c.noop,this.loadingsDone=c.noop,this.loadingsError=c.noop,this.loadingsOffline=c.noop,this.resourceServices={},this.config=new W;var e=r.JsonapiInjector.get(W),t=r.JsonapiInjector.get(X),n=r.JsonapiInjector.get(N);for(var i in this.config)this.config[i]=void 0!==e[i]?e[i]:this.config[i];ne.me=this,ne.injectedServices={JsonapiStoreService:t,JsonapiHttp:n,rsJsonapiConfig:this.config}}te.ɵfac=function(e){return new(e||te)},te.ɵprov=o.ɵɵdefineInjectable({token:te,factory:te.ɵfac}),Z([U,$("design:type",Function),$("design:paramtypes",[String,String]),$("design:returntype",void 0)],te,"removeCachedResource",null),Z([U,$("design:type",Function),$("design:paramtypes",[j]),$("design:returntype",void 0)],te,"setCachedResource",null),Z([U,$("design:type",Function),$("design:paramtypes",[String]),$("design:returntype",void 0)],te,"deprecateCachedCollections",null);var ie=(re.forRoot=function(e){return{ngModule:re,providers:[{provide:W,useValue:e}]}},re);function re(){}ie.ɵmod=o.ɵɵdefineNgModule({type:ie}),ie.ɵinj=o.ɵɵdefineInjector({factory:function(e){return new(e||ie)},providers:[te,X,W,N],imports:[[e.CommonModule],s.HttpClientModule]}),"undefined"!=typeof ngJitMode&&!ngJitMode||o.ɵɵsetNgModuleScope(ie,{imports:[e.CommonModule],exports:[s.HttpClientModule]});var oe=(se.prototype.toparams=function(e){var n=this,i="";return F.forEach(e,function(e,t){i+=n.toparamsarray(e,"&"+t)}),i.slice(1)},se.prototype.toparamsarray=function(e,n){var i=this,r="";return Array.isArray(e)?F.forEach(e,function(e,t){r+=n+"[]="+e}):a.isObject(e)?F.forEach(e,function(e,t){r+=i.toparamsarray(e,n+"["+t+"]")}):r+=n+"="+e,r},se);function se(){}var ae,ce=(n(ue,ae=g),ue.prototype.applyParams=function(e,t){void 0===t&&(t={}),ae.prototype.applyParams.call(this,e,t);var n=new oe;t.remotefilter&&0<Object.keys(t.remotefilter).length&&(e.parseToServer&&e.parseToServer(t.remotefilter),this.addParam(n.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&this.addParam(this.getPageConfig().number+"="+t.page.number),t.page.size&&this.addParam(this.getPageConfig().size+"="+t.page.size)),t.sort&&t.sort.length&&this.addParam("sort="+t.sort.join(","))},ue.prototype.getPageConfig=function(){return te.injectedServices.rsJsonapiConfig.parameters&&te.injectedServices.rsJsonapiConfig.parameters.page||{number:"number",size:"size"}},ue.prototype.addParam=function(e){this.get_params.push(e)},ue);function ue(){return null!==ae&&ae.apply(this,arguments)||this}var de=(he.prototype.getResourceObject=function(){return this.resource_object},he.prototype.removeDuplicatedIncludes=function(){if(!this.resource_object.included||!this.parent_resource_object.included)return this;var e=this.parent_resource_object.included;return this.resource_object.included=this.resource_object.included.filter(function(t){return!i.isEqual(t,e.find(function(e){return e.id===t.id}))}),this.resource_object.included=this.resource_object.included.map(function(t){return e.find(function(e){return e.id===t.id})?new he(t,e.find(function(e){return e.id===t.id})).getResourceObject().data:t}),this},he.prototype.removeDuplicatedRelationships=function(){if(!this.resource_object.data.relationships||!this.parent_resource_object.data.relationships)return this;for(var e in this.resource_object.data.relationships)i.isEqual(this.resource_object.data.relationships[e],this.parent_resource_object.data.relationships[e])&&delete this.resource_object.data.relationships[e];return this},he.prototype.removeDuplicatedAttributes=function(){if(!this.resource_object.data.attributes||!this.parent_resource_object.data.attributes)return this;for(var e in this.resource_object.data.attributes)this.resource_object.data.attributes[e]===this.parent_resource_object.data.attributes[e]&&delete this.resource_object.data.attributes[e];return this},he);function he(e,t,n){this.parent_resource_object=t instanceof j?t.toObject(n):{data:t},!function(e){return e&&e.toObject&&"function"==typeof e.toObject&&e.superToObject&&"function"==typeof e.superToObject}(e)?this.resource_object={data:e}:this.resource_object=e.superToObject(n),this.removeDuplicatedAttributes(),this.removeDuplicatedRelationships(),this.removeDuplicatedIncludes()}var pe,le=(n(fe,pe=j),fe.prototype.toObject=function(e){return new de(this,this.parent,e).getResourceObject()},fe.prototype.superToObject=function(e){return pe.prototype.toObject.call(this,e)},fe.prototype.copySourceFromParent=function(){for(var e in this.source=this.parent.source,this.relationships)this.relationships[e].source=this.parent.relationships[e].source},fe);function fe(e){var t=pe.call(this)||this;t.parent=i.cloneDeep(e),t.type=t.parent.type,delete t.relationships;var n=Object.keys(t.parent.relationships);return t.fill(t.parent.toObject({include:n})),t.copySourceFromParent(),t}var ve=function(e,s,a,c){return new(a||(a=Promise))(function(t,n){function i(e){try{o(c.next(e))}catch(e){n(e)}}function r(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(i,r)}o((c=c.apply(e,s||[])).next())})},ge=(ye.prototype.register=function(){if(null===te.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return te.me.registerService(this)},ye.prototype.newResource=function(){return this.new()},ye.prototype.newCollection=function(){return new x},ye.prototype.new=function(){var e=new this.resource;return e.type=this.type,this.getService(),e.reset(),e},ye.prototype.getPrePath=function(){return""},ye.prototype.getPath=function(){return this.path||this.type},ye.prototype.getClone=function(e,t){return void 0===t&&(t={}),this.get(e,t).pipe(u.map(function(e){return new le(e)}))},ye.prototype.pathForGet=function(e,t){void 0===t&&(t={}),t=Object.assign(Object.assign({},F.ParamsResource),t);var n=new g;return n.applyParams(this,t),n.appendPath(e),n.get()},ye.prototype.get=function(e,t){var n=this;void 0===t&&(t={}),t=Object.assign(Object.assign({},F.ParamsResource),t);var i=new g;i.applyParams(this,t),i.appendPath(e);var r=this.getOrCreateResource(e);r.setLoaded(!1);var o=new c.BehaviorSubject(r);return 0<Object.keys(t.fields||[]).length?this.getGetFromServer(i,r,o):G(r,t.ttl)&&function(e,t){if(0===t.length)return!0;for(var n in e.relationships)if(t.includes(n)&&!e.relationships[n].builded)return!1;return!0}(r,t.include||[])?(r.setLoaded(!0),setTimeout(function(){return o.complete()},0)):0===r.cache_last_update?this.getGetFromLocal(t,i,r).then(function(){o.next(r),setTimeout(function(){return o.complete()},0)}).catch(function(){r.setLoaded(!1),n.getGetFromServer(i,r,o)}):this.getGetFromServer(i,r,o),o.asObservable()},ye.prototype.getGetFromLocal=function(n,i,r){return void 0===n&&(n={}),ve(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:if(!te.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return r.setLoaded(!1),[4,(new z).getResource(z.getResourceKey(r),i.includes)];case 1:if(t=e.sent(),r.fill(t),r.setSource("store"),G(r,n.ttl))return r.setLoadedAndPropagate(!0),[2];throw new Error("Resource is dead!")}})})},ye.prototype.getGetFromServer=function(t,n,i){te.get(t.get()).subscribe(function(e){n.fill(e),n.cache_last_update=Date.now(),n.setLoadedAndPropagate(!0),n.setSourceAndPropagate("server"),te.injectedServices.rsJsonapiConfig.cachestore_support&&(new z).saveResource(n,t.includes),i.next(n),setTimeout(function(){return i.complete()},0)},function(e){n.setLoadedAndPropagate(!0),i.next(n),i.error(e)})},ye.prototype.getService=function(){return b.getService(this.type)||this.register()},ye.prototype.getOrCreateCollection=function(e){var t=this.getService(),n=A.getInstance().getOrCreateCollection(e.getForCache());return n.ttl=t.collections_ttl,"new"!==n.source&&(n.source="memory"),n},ye.prototype.getOrCreateResource=function(e){var t,n=this.getService();return null===(t=A.getInstance().getResource(this.type,e))&&((t=n.new()).id=e,A.getInstance().setResource(t,!1)),"new"!==t.source&&(t.source="memory"),t},ye.prototype.createResource=function(e){var t=b.getServiceOrFail(this.type).new();return t.id=e,A.getInstance().setResource(t,!1),t},ye.prototype.clearCacheMemory=function(){return ve(this,void 0,void 0,function(){return h(this,function(e){return[2,this.clearCache()]})})},ye.prototype.clearCache=function(){return ve(this,void 0,void 0,function(){var t;return h(this,function(e){return(t=new g).applyParams(this),A.getInstance().deprecateCollections(t.getForCache()),[2,(new z).deprecateCollection(t.getForCache()).then(function(){return!0})]})})},ye.prototype.parseToServer=function(e){},ye.prototype.parseFromServer=function(e){},ye.prototype.delete=function(t,e){var n=this;e=Object.assign(Object.assign({},F.ParamsResource),e);var i=new g;i.applyParams(this,e),i.appendPath(t);var r=new c.Subject;return te.delete(i.get()).subscribe(function(e){A.getInstance().removeResource(n.type,t),r.next(),r.complete()},function(e){r.error(e)}),r.asObservable()},ye.prototype.pathForAll=function(e){void 0===e&&(e={});var t=Object.assign(Object.assign({},F.ParamsCollection),e),n=new ce;return n.applyParams(this,t),n.get()},ye.prototype.all=function(e){var t=this;void 0===e&&(e={});var n=Object.assign(Object.assign({},F.ParamsCollection),e);n.ttl||0===n.ttl||(n.ttl=this.collections_ttl);var i=new ce;i.applyParams(this,n);var r=this.getOrCreateCollection(i);r.page.number=1*n.page.number;var o=new c.BehaviorSubject(r);return 0<Object.keys(n.fields).length?this.getAllFromServer(i,n,r,o):G(r,n.ttl)?setTimeout(function(){return o.complete()},0):0===r.cache_last_update?(r.source="new",this.getAllFromLocal(n,i,r).then(function(){o.next(r),setTimeout(function(){o.complete()},0)}).catch(function(){r.setLoaded(!1),t.getAllFromServer(i,n,r,o)})):this.getAllFromServer(i,n,r,o),o.asObservable()},ye.prototype.getAllFromLocal=function(n,i,r){return void 0===n&&(n={}),ve(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:if(!te.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return r.setLoaded(!1),"compact"!==n.store_cache_method?[3,2]:[4,te.injectedServices.JsonapiStoreService.getDataObject("collection",i.getForCache()+".compact")];case 1:return t=e.sent(),[3,4];case 2:return[4,(new z).getCollection(i.getForCache(),i.includes)];case 3:t=e.sent(),e.label=4;case 4:if(r.fill(t),r.setSourceAndPropagate("store"),G(r,n.ttl))return r.setLoadedAndPropagate(!0),r.setBuildedAndPropagate(!0),[2];throw new Error("Collection is dead!")}})})},ye.prototype.getAllFromServer=function(i,r,o,s){o.setLoaded(!1),te.get(i.get()).subscribe(function(e){if(r.cachehash)for(var t in e.data){var n=e.data[t];n.id=n.id+r.cachehash}o.fill(e),o.cache_last_update=Date.now(),o.setCacheLastUpdateAndPropagate(),o.setSourceAndPropagate("server"),o.setLoadedAndPropagate(!0),te.injectedServices.rsJsonapiConfig.cachestore_support&&(new z).saveCollection(i.getForCache(),o,i.includes),te.injectedServices.rsJsonapiConfig.cachestore_support&&"compact"===r.store_cache_method&&te.injectedServices.JsonapiStoreService.saveCollection(i.getForCache()+".compact",e),s.next(o),setTimeout(function(){return s.complete()},0)},function(e){o.setLoadedAndPropagate(!0),s.next(o),s.error(e)})},ye);function ye(){var e=this;this.resource=j,setTimeout(function(){return e.register()})}ge.ɵfac=function(e){return new(e||ge)},ge.ɵprov=o.ɵɵdefineInjectable({token:ge,factory:ge.ɵfac}),r.Autoregister=function(){return function(e){}},r.JsonapiCore=te,r.Resource=j,r.DocumentResource=k,r.DocumentCollection=x,r.Service=ge,r.setJsonapiInjector=function(e){r.JsonapiInjector=e},r.NgxJsonapiModule=ie,r.HttpClient=s.HttpClient,Object.defineProperty(r,"__esModule",{value:!0})});