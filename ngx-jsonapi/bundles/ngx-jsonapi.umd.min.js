!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs/operators"),require("localforage"),require("localforage-getitems"),require("util"),require("rxjs"),require("rxjs/internal/util/noop")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","rxjs/operators","localforage","localforage-getitems","util","rxjs","rxjs/internal/util/noop"],t):t(e["ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.operators,e.localForage,e.localforageGetitems,e.util,e.rxjs,e.noop$1)}(this,function(e,l,t,n,a,r,i,s,c,o){"use strict";var p,u=(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),v=function(r,i){var o,n,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,n&&(a=2&t[0]?n.return:t[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,t[1])).done)return a;switch(n=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,n=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=i.call(r,s)}catch(e){t=[6,e],n=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},h=function(){this.url="",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!1,this.cachestore_support=!1,this.parameters={page:{number:"page[number]",size:"page[size]"}}},d=(f.prototype.exec=function(e,t,r){var i={body:r||null,headers:new n.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})},o=this.http.request(t,e,i);return"get"===t&&o.pipe(a.share()),o},f);function f(e,t){this.http=e,this.rsJsonapiConfig=t}d.decorators=[{type:l.Injectable}],d.ctorParameters=function(){return[{type:n.HttpClient},{type:h}]};function g(){this.builded=!1,this.is_loading=!0,this.source="new",this.cache_last_update=0,this.meta={}}var y=function(){this.number=1,this.total_resources=0,this.size=0,this.resources_per_page=0},m=(b.prototype.applyParams=function(e,t){void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include)},b.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},b.prototype.setApiBaseUrl=function(e){""!==e&&(this.apiBaseUrl=e)},b.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},b.prototype.get=function(){var e=this.get_params.slice();return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.apiBaseUrl+this.paths.join("/")+(0<e.length?B.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},b.prototype.setInclude=function(e){this.includes=e},b);function b(){this.paths=[],this.includes=[],this.get_params=[],this.apiBaseUrl=""}var _,S=(u(w,_=g),w.prototype.fill=function(e){this.data_resource=e,this.data.fill(e),this.meta=e.meta||{}},w);function w(){var e=_.apply(this,arguments)||this;return e.data=new C,e.builded=!1,e.content="id",e.page=new y,e}var j=(R.prototype.buildRelationships=function(){for(var e in this.relationships_from){var t=this.relationships_from[e];t.data&&(this.relationships_dest[e]instanceof D?this.__buildRelationshipHasMany(t,e):this.relationships_dest[e]instanceof S&&this.__buildRelationshipHasOne(t,e))}},R.prototype.__buildRelationshipHasMany=function(e,t){var r=e.data[0]?e.data[0].type:"";""!==r&&(t=t||r,this.getService(r)?0!==e.data.length?this.relationships_dest[t].fill(e,this.included_resources):this.relationships_dest[t]=new D:l.isDevMode()&&console.warn("The relationship "+t+" (type",r,") cant be generated because service for this type has not been injected."))},R.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(e.data.id!==this.relationships_dest[t].data.id&&(this.relationships_dest[t].data=new C),this.relationships_dest[t].data.id!==e.data.id){var r=this.__buildRelationship(e.data,this.included_resources);r&&(this.relationships_dest[t].data=r,this.relationships_dest[t].builded=!0)}}else this.relationships_dest[t].data=[]},R.prototype.__buildRelationship=function(e,t){if(e.type in t&&e.id in t[e.type]){var r=t[e.type][e.id];return this.getService(e.type).cachestore.setResource(r),r}var i=this.getService(e.type);if(i&&e.id in i.cachememory.resources)return i.cachememory.resources[e.id]},R);function R(e,t,r,i){this.getService=e,this.relationships_from=t,this.relationships_dest=r,this.included_resources=i}var C=(O.prototype.reset=function(){for(var e in this.id="",this.attributes={},this.is_new=!0,this.relationships)this.relationships[e]=this.relationships[e]instanceof D?new D:new S},O.prototype.toObject=function(e){e=Object.assign({},F.ParamsResource,e);var t,r={},i=[],o=[];for(var n in this.relationships){var a=this.relationships[n];if(a instanceof D){a.builded||a.data&&0!==a.data.length?r[n]={data:[]}:delete r[n];for(var s=0,c=a.data;s<c.length;s++){var l=c[s],p={id:l.id,type:l.type};r[n].data.push(p);var u=l.type+"_"+l.id;-1===o.indexOf(u)&&-1!==e.include.indexOf(n)&&(o.push(u),i.push(l.toObject({}).data))}}else{if(null===a.data){r[n]={data:null};continue}a instanceof S||console.warn(a," is not DocumentCollection or DocumentResource");var h=a.data;!("id"in a.data)&&0<Object.keys(a.data).length&&console.warn(n+" defined with hasMany:false, but I have a collection"),h.id&&h.type?r[n]={data:{id:h.id,type:h.type}}:a.builded||h.id||h.type||delete r[n],u=h.type+"_"+h.id,-1===o.indexOf(u)&&-1!==e.include.indexOf(n)&&(o.push(u),i.push(h.toObject({}).data))}}this.getService()&&this.getService().parseToServer?(t=Object.assign({},this.attributes),this.getService().parseToServer(t)):t=this.attributes;var d={data:{type:this.type,id:this.id,attributes:t,relationships:r},builded:!1,content:"resource"};return 0<i.length&&(d.included=i),d},O.prototype.fill=function(e,t){t=t||P.buildIncluded(e),this.id=e.data.id||"",this.attributes=e.data.attributes||this.attributes,this.data_resource=e,this.is_new=!1,P.getService(e.data.type)&&(Object.keys(this.attributes).length&&P.getService(this.type).parseFromServer(this.attributes),this.relationships_definitions&&(e.data.relationships=this.relationships,this.relationships=this.relationships_definitions),new j(P.getService,e.data.relationships||{},this.relationships,t).buildRelationships())},O.prototype.addRelationship=function(e,t){var r=this.relationships[t||e.type];r instanceof D?r.replaceOrAdd(e):r.data=e},O.prototype.addRelationships=function(e,t){var r=this;if(0!==e.length){if(!(this.relationships[t]instanceof D))throw new Error("addRelationships require a DocumentCollection (hasMany) relation.");e.forEach(function(e){r.addRelationship(e,t)})}},O.prototype.addRelationshipsArray=function(e,t){this.addRelationships(e,t)},O.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;var r=this.relationships[e];return r instanceof D?r.data=r.data.filter(function(e){return e.id!==t}):r.data.reset(),!0},O.prototype.hasManyRelated=function(e){return this.relationships[e]&&0<this.relationships[e].data.length},O.prototype.hasOneRelated=function(e){return this.relationships[e]&&this.relationships[e].data.type&&""!==this.relationships[e].data.type},O.prototype.getService=function(){return P.getService(this.type)},O.prototype.save=function(e){var t=this;if(e=Object.assign({},F.ParamsResource,e),this.is_saving||this.is_loading)return c.of({});this.is_saving=!0;var r=new c.Subject,i=this.toObject(e);""===this.id&&delete i.data.id;var o=new m;return o.applyParams(this.getService(),e),this.id&&o.appendPath(this.id),B.exec(o.get(),this.id?"PATCH":"POST",i,!0).subscribe(function(e){t.is_saving=!1,t.id||(t.getService().cachememory.deprecateCollections(o.get()),t.getService().cachestore.deprecateCollections(o.get())),"id"in e.data?(t.id=e.data.id,t.fill(e)):s.isArray(e.data)&&console.warn("Server return a collection when we save()",e.data),r.next(e),r.complete()},function(e){t.is_saving=!1,r.error("data"in e?e.data:e)}),r},O);function O(){this.id="",this.type="",this.attributes={},this.relationships={},this.relationships_definitions=void 0,this.links={},this.is_new=!0,this.is_saving=!1,this.is_loading=!1,this.source="new",this.cache_last_update=0}var P=(x.json_array2resources_array_by_type=function(e){var t={},r={};for(var i in x.json_array2resources_array(e,t),t){var o=t[i];o.type in r||(r[o.type]={}),r[o.type][o.id]=o}return r},x.json2resource=function(e,t){if(x.getService(e.type))return x.procreate(e);l.isDevMode()&&console.warn("`"+e.type+"`","service not found on json2resource().","Use @Autoregister() on service and inject it on component.");var r=new C;return r.id=e.id,r.type=e.type,r},x.getService=function(e){return B.me.getResourceService(e)},x.buildIncluded=function(e){return"included"in e?x.json_array2resources_array_by_type(e.included):{}},x.procreate=function(e){var t;return"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e),(t=e.id in x.getService(e.type).cachememory.resources?x.getService(e.type).cachememory.resources[e.id]:x.getService(e.type).getOrCreateResource(e.id)).attributes=e.attributes||{},t.relationships_definitions=t.relationships,t.relationships=e.relationships,t.is_new=!1,t},x.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var r=0,i=e;r<i.length;r++){var o=i[r],n=x.json2resource(o,!1);t[n.type+"_"+n.id]=n}},x);function x(){}var A,D=(u(E,A=g),E.prototype.trackBy=function(e){return e.id},E.prototype.find=function(e){for(var t=0;t<this.data.length;t++)if(this.data[t].id===e)return this.data[t];return null},E.prototype.fill=function(e,t){this.data_collection=e,t=t||P.buildIncluded(e),this.page&&e.meta&&(this.page.number=e.meta.page||1,this.page.resources_per_page=e.meta.resources_per_page||null,this.page.size=e.meta.resources_per_page||null,this.page.total_resources=e.meta.total_resources||null);var r={};this.data=[],this.builded=e.data&&0===e.data.length;for(var i=0,o=e.data;i<o.length;i++){var n=o[i],a=this.find(n.id)||P.getService(n.type).getOrCreateResource(n.id);a.fill({data:n},t),r[n.id]=n.id,this.data.push(a),0<Object.keys(a.attributes).length&&(this.builded=!0)}for(var s=void 0;s<this.data.length;s++)this.data[s].id in r||delete this.data[s];this.meta=e.meta||{}},E.prototype.replaceOrAdd=function(e){var t=this.find(e.id);null===t?this.data.push(e):t=e},E.prototype.hasMorePages=function(){return this.page.size<1?null:this.page.size*(this.page.number-1)+this.data.length<this.page.total_resources},E);function E(){var e=A.apply(this,arguments)||this;return e.data=[],e.page=new y,e}var F=(J.newCollection=function(){return new D},J.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},J.forEach=function(t,r){Object.keys(t).forEach(function(e){r(t[e],e)})},J);function J(){}F.ParamsResource={beforepath:"",ttl:null,include:[],id:""},F.ParamsCollection={beforepath:"",ttl:null,include:[],remotefilter:{},smartfilter:{},sort:[],page:new y,storage_ttl:0,cachehash:""};var M=function(n,a,s,c){return new(s||(s=Promise))(function(e,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,i)}o((c=c.apply(n,a||[])).next())})};i.extendPrototype(r);var I=(k.prototype.getDataObject=function(e,t){var r=new c.Subject;return this.allstore.getItem("jsonapi."+e+"."+t).then(function(e){null===e?r.error(null):r.next(e),r.complete()}).catch(function(e){return r.next(e)}),r.asObservable()},k.prototype.getDataResources=function(t){return M(this,void 0,void 0,function(){return v(this,function(e){return[2,this.allstore.getItems(t.map(function(e){return"jsonapi."+e}))]})})},k.prototype.saveResource=function(e,t,r){var i=Object.assign({_lastupdate_time:Date.now()},r);this.allstore.setItem("jsonapi."+e+"."+t,i)},k.prototype.saveCollection=function(e,t){var r=Object.assign({_lastupdate_time:Date.now()},t);this.allstore.setItem("jsonapi.collection."+e,r)},k.prototype.clearCache=function(){this.allstore.clear(),this.globalstore.clear()},k.prototype.deprecateObjectsWithKey=function(r){var i=this;this.allstore.keys().then(function(e){F.forEach(e,function(t){t.startsWith(r)&&i.allstore.getItem(t).then(function(e){e._lastupdate_time=0,i.allstore.setItem(t,e)}).catch(c.noop)})}).catch(c.noop)},k.prototype.checkIfIsTimeToClean=function(){var t=this;this.globalstore.getItem("_lastclean_time").then(function(e){Date.now()>=e.time+432e5&&(t.globalstore.setItem("_lastclean_time",{time:Date.now()}),t.checkAndDeleteOldElements())}).catch(function(){t.globalstore.setItem("_lastclean_time",{time:Date.now()})})},k.prototype.checkAndDeleteOldElements=function(){var r=this;this.allstore.keys().then(function(e){F.forEach(e,function(t){r.allstore.getItem(t).then(function(e){Date.now()>=e._lastupdate_time+864e5&&r.allstore.removeItem(t)}).catch(c.noop)})}).catch(c.noop)},k);function k(){this.globalstore&&this.checkIfIsTimeToClean()}var B=(T.delete=function(e){return T.exec(e,"DELETE")},T.get=function(e){return T.exec(e,"get")},T.exec=function(e,t,r,i){return void 0===i&&(i=!0),T.me.refreshLoadings(1),T.injectedServices.JsonapiHttp.exec(e,t,r).pipe(a.tap(function(){return T.me.refreshLoadings(-1)}),a.catchError(function(e){return e=e.error||e,T.me.refreshLoadings(-1),e.status<=0?!T.me.loadingsOffline(e)&&l.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):i&&!T.me.loadingsError(e)&&l.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),c.throwError(e)}))},T.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},T.prototype.getResourceService=function(e){return this.resourceServices[e]},T.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},T.prototype.clearCache=function(){return T.injectedServices.JsonapiStoreService.clearCache(),!0},T.prototype.duplicateResource=function(r){for(var i=this,o=[],e=1;e<arguments.length;e++)o[e-1]=arguments[e];var n=this.getResourceService(r.type).new();function t(t){var e=r.relationships[t];"id"in e.data?-1<o.indexOf(t)?n.addRelationship(a.duplicateResource(e.data),t):n.addRelationship(e.data,t):-1<o.indexOf(t)?Object.values(e.data).forEach(function(e){n.addRelationship(i.duplicateResource(e),t)}):n.addRelationships(e.data,t)}n.attributes=Object.assign({},n.attributes,r.attributes);var a=this;for(var s in r.relationships)t(s);return n},T);function T(e,t,r){for(var i in this.loadingsCounter=0,this.loadingsStart=o.noop,this.loadingsDone=o.noop,this.loadingsError=o.noop,this.loadingsOffline=o.noop,this.resourceServices={},this.config=new h,this.config)this.config[i]=void 0!==e[i]?e[i]:this.config[i];T.me=this,T.injectedServices={JsonapiStoreService:t,JsonapiHttp:r,rsJsonapiConfig:this.config}}B.decorators=[{type:l.Injectable}],B.ctorParameters=function(){return[{type:h,decorators:[{type:l.Optional}]},{type:I},{type:d}]};var U=(H.forRoot=function(e){return{ngModule:H,providers:[{provide:h,useValue:e}]}},H);function H(e,t){if(e)throw new Error("NgxJsonapiModule is already loaded. Import it in the AppModule only")}U.decorators=[{type:l.NgModule,args:[{imports:[t.CommonModule],exports:[n.HttpClientModule],providers:[B,I,h,d]}]}],U.ctorParameters=function(){return[{type:U,decorators:[{type:l.Optional},{type:l.SkipSelf}]},{type:B}]};var q=(z.prototype.isCollectionExist=function(e){return e in this.collections&&"new"!==this.collections[e].source},z.prototype.isCollectionLive=function(e,t){return Date.now()<=this.collections_lastupdate[e]+1e3*t},z.prototype.isResourceLive=function(e,t){return this.resources[e]&&Date.now()<=this.resources[e].lastupdate+1e3*t},z.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=new D,this.collections[e].source="new"),this.collections[e]},z.prototype.setCollection=function(e,t){e in this.collections||(this.collections[e]=new D);for(var r=0;r<t.data.length;r++){var i=t.data[r];this.setResource(i)}this.collections[e].data=t.data,this.collections[e].page=t.page,this.collections_lastupdate[e]=Date.now()},z.prototype.getOrCreateResource=function(e,t){if(P.getService(e).cachememory&&t in P.getService(e).cachememory.resources)return P.getService(e).cachememory.resources[t];var r=P.getService(e).new();return r.id=t,this.setResource(r,!1),r},z.prototype.setResource=function(e,t){void 0===t&&(t=!1),e.id in this.resources?this.addResourceOrFill(e):this.resources[e.id]=e,this.resources[e.id].lastupdate=t?Date.now():0},z.prototype.deprecateCollections=function(e){var r=this;return F.forEach(this.collections_lastupdate,function(e,t){r.collections_lastupdate[t]=0}),!0},z.prototype.removeResource=function(r){for(var e in F.forEach(this.collections,function(e,t){delete e[r]}),this.resources[r].attributes={},this.resources[r].relationships)this.resources[r].relationships[e].data.constructor===Array?this.resources[r].relationships[e].data=[]:this.resources[r].relationships[e].data.constructor===Object&&delete this.resources[r].relationships[e].data;delete this.resources[r]},z.prototype.addResourceOrFill=function(e){var t=this.resources[e.id];for(var r in t.attributes=e.attributes,t.relationships)if(void 0!==t.relationships[r].data)if(r in e.relationships){var i=t.relationships[r];if(!Array.isArray(i.data))continue;for(var o=0,n=i.data;o<n.length;o++){var a=n[o];null===i.find(a.id)&&delete t.relationships[r]}}else delete t.relationships[r];for(var r in e.relationships)void 0!==e.relationships[r].data&&("id"in e.relationships[r].data?t.addRelationship(e.relationships[r].data,r):t.addRelationships(e.relationships[r].data,r))},z);function z(){this.resources={},this.collections={},this.collections_lastupdate={}}var L=function(n,a,s,c){return new(s||(s=Promise))(function(e,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,i)}o((c=c.apply(n,a||[])).next())})},W=(G.prototype.getResource=function(c,l){return void 0===l&&(l=[]),L(this,void 0,void 0,function(){var s=this;return v(this,function(e){return[2,new Promise(function(n,a){B.injectedServices.JsonapiStoreService.getDataObject(c.type,c.id).subscribe(function(e){c.fill({data:e});for(var t=[],r=0,i=l;r<i.length;r++){var o=i[r];s.fillRelationshipFromStore(c,o,t)}0===t.length?n(e):Promise.all(t).then(function(e){n(e)}).catch(function(e){a(e)})},function(){a()})})]})})},G.prototype.setResource=function(e){B.injectedServices.JsonapiStoreService.saveResource(e.type,e.id,e.toObject().data)},G.prototype.setCollection=function(e,t,r){for(var i=this,o={data:[],page:new y},n={},a=0,s=t.data;a<s.length;a++){var c=s[a];this.setResource(c),o.data.push({id:c.id,type:c.type});for(var l=0,p=r;l<p.length;l++){var u=p[l];if("id"in c.relationships[u].data){var h=c.relationships[u].data;n[u+h.id]=h}else for(var d=0,f=c.relationships[u].data;d<f.length;d++){var v=f[d];n[u+v.id]=v}}}o.page=t.page,B.injectedServices.JsonapiStoreService.saveCollection(e,o),F.forEach(n,function(e){"is_new"in e&&(0!==Object.keys(e.attributes).length?i.setResource(e):console.warn("No se pudo guardar en la cache",e.type,"por no tener attributes.",e))})},G.prototype.deprecateCollections=function(e){return B.injectedServices.JsonapiStoreService.deprecateObjectsWithKey("collection."+e),!0},G.prototype.fillCollectionFromStore=function(e,t,r){var i=this,o=new c.Subject;return B.injectedServices.JsonapiStoreService.getDataObject("collection",e).subscribe(function(e){if(i.fillCollectionWithArrrayAndResourcesOnMemory(e.data,r))return r.source="store",r.cache_last_update=e._lastupdate_time,o.next(r),void o.complete();i.fillCollectionWithArrrayAndResourcesOnStore(e,t,r).then(function(){if("new"!==r.source)throw console.warn("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#",r),new Error("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#");r.source="store",r.cache_last_update=e._lastupdate_time,o.next(r),setTimeout(function(){return o.complete()})}).catch(function(e){return o.error(e)})},function(e){return o.error(e)}),o},G.prototype.fillCollectionWithArrrayAndResourcesOnMemory=function(e,t){for(var r=!0,i=0,o=e;i<o.length;i++){var n=o[i],a=this.getResourceFromMemory(n);if(a.is_new){r=!1;break}t.replaceOrAdd(a)}return r},G.prototype.getResourceFromMemory=function(e){return P.getService(e.type).cachememory.getOrCreateResource(e.type,e.id)},G.prototype.fillCollectionWithArrrayAndResourcesOnStore=function(h,d,f){return L(this,void 0,void 0,function(){var u=this;return v(this,function(e){return[2,new Promise(function(c,l){var p={},e=h.data.map(function(e){var t=P.getService(e.type).cachememory;return p[e.id]=t.getOrCreateResource(e.type,e.id),p[e.id].type+"."+e.id});B.injectedServices.JsonapiStoreService.getDataResources(e).then(function(r){function e(e){var t=r[e];p[t.id].fill({data:t}),F.forEach(d,function(e){u.fillRelationshipFromStore(p[t.id],e,i)}),p[t.id].lastupdate=t._lastupdate_time}var i=[];for(var t in r)e(t);if(0===i.length){h.page&&(f.page.number=h.page.number);for(var o=0,n=h.data;o<n.length;o++){var a=n[o],s=p[a.id];-1===f.data.indexOf(s)&&f.data.push(s)}c(null)}else Promise.all(i).then(function(e){h.page&&(f.page.number=h.page.number);for(var t=0,r=h.data;t<r.length;t++){var i=r[t],o=p[i.id];f.data.push(o)}c(null)}).catch(function(e){l(e)})}).catch(function(e){l(e)})})]})})},G.prototype.fillRelationshipFromStore=function(e,t,r){if(t.includes(".")){var i=t.split("."),o=e.relationships[i[0]].data;if(o instanceof S)return this.fillRelationshipFromStore(o.data,i[1],r);if(o instanceof D){for(var n=0,a=o.data;n<a.length;n++){var s=a[n];this.fillRelationshipFromStore(s,i[1],r)}return}}if(e.relationships[t]instanceof S&&!("attributes"in(s=e.relationships[t].data))){var c=this.getResourceFromMemory(s);c.is_new?r.push(this.getResource(c)):l.isDevMode()&&console.warn("ts-angular-json: esto no debería pasar #isdjf2l1a"),e.addRelationship(c,t)}},G);function G(){}function N(e,t){return void 0===t&&(t=null),Date.now()<=e.cache_last_update+1e3*(t||e.ttl||0)}var K=(V.prototype.toparams=function(e){var r=this,i="";return F.forEach(e,function(e,t){i+=r.toparamsarray(e,"&"+t)}),i.slice(1)},V.prototype.toparamsarray=function(e,r){var i=this,o="";return Array.isArray(e)||s.isObject(e)?F.forEach(e,function(e,t){o+=i.toparamsarray(e,r+"["+t+"]")}):o+=r+"="+e,o},V);function V(){}var $,Q=(u(X,$=m),X.prototype.applyParams=function(e,t){void 0===t&&(t={}),$.prototype.applyParams.call(this,e,t);var r=new K;t.remotefilter&&0<Object.keys(t.remotefilter).length&&(e.parseToServer&&e.parseToServer(t.remotefilter),this.addParam(r.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&this.addParam(B.injectedServices.rsJsonapiConfig.parameters.page.number+"="+t.page.number),t.page.size&&this.addParam(B.injectedServices.rsJsonapiConfig.parameters.page.size+"="+t.page.size)),t.sort&&t.sort.length&&this.addParam("sort="+t.sort.join(","))},X.prototype.addParam=function(e){this.get_params.push(e)},X);function X(){return null!==$&&$.apply(this,arguments)||this}var Y=(Z.prototype.register=function(){if(null===B.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return this.cachememory=new q,this.cachestore=new W,B.me.registerService(this)},Z.prototype.newResource=function(){return new this.resource},Z.prototype.newCollection=function(){return new D},Z.prototype.new=function(){var e=this.newResource();return e.type=this.type,this.getService(),e.reset(),e},Z.prototype.getPrePath=function(){return""},Z.prototype.getPath=function(){return this.path||this.type},Z.prototype.pathForGet=function(e,t){void 0===t&&(t={}),t=Object.assign({},F.ParamsResource,t);var r=new m;return r.applyParams(this,t),r.appendPath(e),r.setApiBaseUrl(this.apiBaseUrl),r.get()},Z.prototype.get=function(e,t){var r=this;void 0===t&&(t={}),t=Object.assign({},F.ParamsResource,t);var i=new m;i.applyParams(this,t),i.appendPath(e),i.setApiBaseUrl(this.apiBaseUrl);var o=this.getOrCreateResource(e);o.is_loading=!0;var n=new c.BehaviorSubject(o);return N(o,t.ttl)?(n.complete(),o.is_loading=!1):B.injectedServices.rsJsonapiConfig.cachestore_support?this.getService().cachestore.getResource(o,t.include).then(function(){if(!N(o,t.ttl))throw n.next(o),new Error("No está viva la caché de localstorage");o.is_loading=!1,n.next(o),n.complete()}).catch(function(){r.getGetFromServer(i,o,n)}):this.getGetFromServer(i,o,n),n.next(o),n.asObservable()},Z.prototype.getGetFromServer=function(e,t,r){var i=this;B.get(e.get()).subscribe(function(e){t.fill(e),t.is_loading=!1,i.getService().cachememory.setResource(t),B.injectedServices.rsJsonapiConfig.cachestore_support&&i.getService().cachestore.setResource(t),r.next(t),r.complete()},function(e){r.error(e)})},Z.prototype.getService=function(){return P.getService(this.type)||this.register()},Z.prototype.getOrCreateCollection=function(e){return this.getService().cachememory.getOrCreateCollection(e.getForCache())},Z.prototype.getOrCreateResource=function(e){var t=this.getService();if(t.cachememory&&e in t.cachememory.resources)return t.cachememory.resources[e];var r=t.new();return r.id=e,t.cachememory.setResource(r,!1),r},Z.prototype.clearCacheMemory=function(){var e=new m;return e.applyParams(this),e.setApiBaseUrl(this.apiBaseUrl),this.getService().cachememory.deprecateCollections(e.getForCache())&&this.getService().cachestore.deprecateCollections(e.getForCache())},Z.prototype.parseToServer=function(e){},Z.prototype.parseFromServer=function(e){},Z.prototype.delete=function(t,e){var r=this;e=Object.assign({},F.ParamsResource,e);var i=new m;i.applyParams(this,e),i.appendPath(t),i.setApiBaseUrl(this.apiBaseUrl);var o=new c.Subject;return B.delete(i.get()).subscribe(function(e){r.getService().cachememory.removeResource(t),o.next(),o.complete()},function(e){o.error(e)}),o.asObservable()},Z.prototype.pathForAll=function(e,t){void 0===e&&(e={}),void 0===t&&(t=""),e=Object.assign({},F.ParamsCollection,e);var r=new Q;return r.applyParams(this,e),r.setApiBaseUrl(this.apiBaseUrl),r.get()},Z.prototype.all=function(t){var r=this;void 0===t&&(t={}),t=Object.assign({},F.ParamsCollection,t);var i=new Q;i.applyParams(this,t),i.setApiBaseUrl(this.apiBaseUrl);var o=this.getOrCreateCollection(i);o.page.number=1*t.page.number;var n=new c.BehaviorSubject(o);return N(o,t.ttl)?(o.source="memory",n.next(o),setTimeout(function(){return n.complete()},0)):B.injectedServices.rsJsonapiConfig.cachestore_support?(o.is_loading=!0,this.getService().cachestore.fillCollectionFromStore(i.getForCache(),i.includes,o).subscribe(function(){o.source="store",r.getService().cachememory.setCollection(i.getForCache(),o),N(o,t.ttl)?(o.is_loading=!1,n.next(o),n.complete()):r.getAllFromServer(i,t,o,n)},function(e){r.getAllFromServer(i,t,o,n)})):this.getAllFromServer(i,t,o,n),n.asObservable()},Z.prototype.getAllFromServer=function(i,o,n,a){var s=this;n.is_loading=!0,a.next(n),B.get(i.get()).subscribe(function(e){if(n.source="server",n.is_loading=!1,o.cachehash)for(var t in e.data){var r=e.data[t];r.id=r.id+o.cachehash}n.fill(e),n.cache_last_update=Date.now(),s.getService().cachememory.setCollection(i.getForCache(),n),B.injectedServices.rsJsonapiConfig.cachestore_support&&s.getService().cachestore.setCollection(i.getForCache(),n,o.include),a.next(n),a.complete()},function(e){n.is_loading=!1,a.next(n),a.error(e)})},Z);function Z(){this.resource=C}e.Autoregister=function(){return function(e){function t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];function r(){return o.apply(this,arguments)}r.prototype=Object.create(o.prototype);var i=new(r.bind.apply(r,[void 0].concat(e)));return i.register(),i}var o=e;return t.prototype=Object.create(e.prototype),t}},e.JsonapiCore=B,e.Resource=C,e.DocumentResource=S,e.DocumentCollection=D,e.Service=Y,e.NgxJsonapiModule=U,e.ɵd=g,e.ɵa=h,e.ɵc=d,e.ɵb=I,Object.defineProperty(e,"__esModule",{value:!0})});